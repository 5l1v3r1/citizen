sudo: required
language: node_js
node_js:
- '8'
stages:
- lint
- test
- prepare deploy
- github releas
- docker release
services:
- docker
cache:
  directories:
  - test/integration/temp
before_install:
- npm install -g npm@latest
- npm --version
install:
- npm ci
- "./test/integration/download-terraform"
env:
  global:
  - CITIZEN_HOSTNAME=localhost
  - CITIZEN_STORAGE=file
  - CITIZEN_STORAGE_PATH=/tmp/citizen
  - CITIZEN_ADDR=http://127.0.0.1:3000
  - CITIZEN_MOCK_ENABLED=true
  - CITIZEN_AWS_S3_BUCKET=kr.ne.outsider.test
  - AWS_ACCESS_KEY_ID=ooooo
  - AWS_SECRET_ACCESS_KEY=xxxxx
  - DEBUG=*,-mocha:*,-express:*,-nock.*,-pouchdb:*,-eslint:*,-eslint*,-snapdragon:*,-body-parser:*,-morgan,-superagent
  - DOCKER_USER=outsideris
  # DOCKER_PASS
  - secure: CTQdx2jVlL0zLSUn0gD2r/f9m6Jnroiaq4ZhZ33E12g94G0tmygnrWtLoZmufgGeh8H6CDtaYMayk2GeY+69UZEYLrwdOriAlPZVpYODShjN+P3CwqJOCLSaRysFbSubvRHl1YyLWS4bYC/hjHFHSr5QiIXAUGD9HaDYynMfi3cO6MWfEWujHHnoM6eAIne/UjfzNb4rOOo84JVsCVLU31DXaoDb2yJi8e1AKDpvev2nRpS0hfH59DDNe1XzZ719S3YP5+r0lxPQmY7oHrs3t4XAsPi/hPue6BxWeIHS3YmdK6jSWvoxQwE9m2YGTJOuI2OwBTSUo6bY0bjgZyZz0YulM3+lnQR/inAecnXndv8ITTzzsteZt3nTfuqdYxci4Q/Copwbf5W/nS9YJhXGtttkVWsYTlbMKUFBwlmX9iRnQNVF2Uc0NSe7nHucjGfikOdX1ckRrtsCT/jACcDx3wQ9r5/scD1pGawgNA8rUZ9TpzDZ8etz55df9ZqYVF/wI1atY58skqS40mexm0GHG/28NQZe/BI+cXa4vtxfDOAqPDvjfu84KLzXOQUoeJA8ZJ15FQzFaxw4fNWRn57I+lqiIbdjpowiwG9RK/QrrVd39ld40HqYnM+E7FGEeam1KsvSDxOCUcP14ZU/fI1TE4+MNmBTkZHOg+g9wJD4Bag=

jobs:
  include:
  - stage: lint
    script: npm run lint
  - stage: test
    script: npm test -- --forbid-only
    node_js: '8'
  - stage: test
    script: npm test -- --forbid-only
    node_js: '10'
  - stage: prepare deploy
    script: skip
    deploy:
      provider: script
      script: npm run build
      skip_cleanup: true
      on:
        tags: true
  - stage: github release
    script: echo "Deploying to GitHub releases"
    deploy:
      provider: releases
      api_key:
        secure: mUU9a65fvVZaMb8vuNZ2a7d8VDtrdtXPv7suoZTEAIdG3M/koINOoDJU49ulWv8yxQXA/yMzXImOfj1RuryoLp+1kmxqgmeZCHG00ncS0EyNAo8On+Wgw3VB8qevYXJfSWvuG5BDL8P//0h4PSUjZmd0YpB7CHEmt+1FHIPC2HIiU5pmEsaRthGzQy3wB8NnFvp8n+t2MIlXSg1ZEaeVhLKHnte6ddt6Hc9rPbXtPOHODEl/FOdO2GSFNtkr90P0U/VZM+6Wqsh0b9kuQDcgHC2Vgoy5SzUOGjxGDOVSzDp+vI54cznzq+vh4/6S+nF2uXiBFONtYOHwTWwZpPnaLSdCKevYUWgkJKCIrf98v3rb9ds8ocXZutM+GhDeO3o/Eh94ydua/aHzF9aeroc3gpeYcV9NZOqh+yMH6jo3/u4b1hmGRdu0V6aQe0HVmRWjPcTHcV+laAC7Mt/MeAX9FX+TwnPZhflwTIWER0r2mb8Bhnqsg5TkMDAWoE6t8p1zk25nC0lCxWbVdtO8W0Q9KGgvkskoNxdoVy0v4JnwiljebXnImei/FDCgHKuJP+sSZCrDiMsRCuFyxX7kCCOBzopIeMBjNEDZ3QIHta/AsWH/MjgOGLOxWQ17NKshGcvXwv97SFdlax6Ut0q/+S6L+N9W8tJ8uWwKY7JFByI6p2Y=
      file_glob: true
      file: dist/*
      skip_cleanup: true
      on:
        tags: true
  - stage: docker release
    script: echo "Deploying Dokcer image"
    deploy:
      provider: script
      script: bash scripts/docker-deploy.sh
      skip_cleanup: true
      on:
        repo: outsideris/citizen
        tags: true
